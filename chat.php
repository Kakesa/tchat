<?php
  //Démarer la session
  session_start();
  if(!isset( $_SESSION['user'])){
    //si l'util n'est pas connecté
    header("location:Ho.php");
  }
  $user =  $_SESSION['user'];//email de l'utisateur
?>

<!DOCTYPE html>
<html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title><?=$user?></title>
      <link rel="stylesheet" href="style.css">
  </head>
  <body>
      <div class="chat">
          <span><?=$user?></span>
          <a href="deconnexion.php" class="Deconnexion_btn">Déconnexion</a>
        <!-- message -->
      <div class="message_box">
          <?php
            include "messages.php";
          ?>
      </div>
        <!-- fin message -->

        <?php 
          //envoie des messages
          if(isset($_POST['send'])){
            $message = $_POST['message'];
            //connection bdd
            include("connexion_db.php");
            //verifions si le champs n'est pas vide 
            if(isset($message) && $message != ""){
              //inserer le message dans la bdd

              $sql = "INSERT INTO messages VALUES (NULL, '$user' , '$message', NOW())";
              if($conn->query($sql)){
                header("location:chat.php");
            }else{
              header("location:chat.php");
           }
          }
        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        ?>
        
        <form action="" class="send_message" method="POST">
          <textarea name="message" id="" cols="10" rows="2" placeholder="Votre message"></textarea>
          <p style="text-align:center;">
          <input type="submit" value="Envoyer" name="send">
          </p>
        </form>
      </div>
      <script>
        var message_box = document.querySelector('.message_box');
        setInterval(function(){
          var xhttp = new XMLHttpRequest();
             xhttp.onreadystatechange = function(){
              if(this.readyState == 4 && this.status ==200){
                message_box.innerHTML = this.responseText;
              }
              
             };
             xhttp.open("GET","messages.php",true);
             xhttp.send()
        },500)
      </script>
  </body>
</html>